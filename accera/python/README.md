# Accera
Accera Python Bindings

## Goal

General idea is to offer an easy way to program the DSL and emit the relevant
binaries. Separating the compiler from the language allows for the two to
leverage the best of both C++ and Python.

The Python packaging infrastructure is also being leveraged to distribute
binaries and provide an API that uses them. These are used to compile the
output from the Accera compiler to machine code.

From LLVM, the following binaries are included in the `accera-llvm` package:

* llc
* opt
* mlir-translate

## Installing the package locally

To build the packages for local testing (replace `<path_to_accera>` with the path to the cloned Accera repository):
```shell
cd <path_to_accera>
python setup.py build
```

To build the Debug version, add the `-g` option. On Windows, you will also need
the Debug version of LLVM binaries built with the `/MDd` flag.
```shell
python setup.py -g
```

The build commands will create directories that matche `build/lib.*`, where the prefix
depends on your system and python version. If you execute python within this
directory, you can `import accera` as if it were a normal package install.

To install the package for yourself on the current system, you can run
```shell
python -m pip install -U pip
python -m pip install --user -e .
```

## Tests

These are in the `test` folder and written using `unittest`.

```shell
cd <path_to_accera>
python setup.py build
cd build/lib.linux-x86_64-3.7
python -m unittest discover accera/test "*.py"
```

It is generally a good idea to run tests at least once for each version
of Python we support, so that you can catch compatibility issues.

## Generating packages
To generate the *.whls, we will need to invoke each `setup.py` separately.
Unlike the local testing mode, the binaries need to be partitioned into
their respective package staging folders before uploading to PyPI.

A summary of the packages that you can generate:

|Package|Depends on|Build PyPI whl from|
|--|--|--|
|accera|accera-compilers, accera-llvm|`<path_to_accera>`|
|accera-compilers|-|`<path_to_accera>/accera/python/compilers`|
|accera-llvm|-|`<path_to_accera>/accera/python/llvm`|
|accera-gpu|-|`<path_to_accera>/accera/python/gpu`|

```shell
# Disable development mode if you need to upload to PyPI.
# (Otherwise, the accera package will be a superset of all the packages.)
export ACCERA_PACKAGE_FOR_CI=1

# build the accera package
# staging folder: <path_to_accera>/build/lib.*
# package folder: <path_to_accera>/dist
cd <path_to_accera>
python setup.py bdist_wheel

# build the accera-compilers package
# staging folder: <path_to_accera>/build/lib.*-accera_compilers
# package folder: <path_to_accera>/accera/python/compilers/dist
cd accera/python/compilers
python setup.py bdist_wheel

# build the accera-llvm package
# staging folder: <path_to_accera>/build/lib.*-accera_llvm
# package folder: <path_to_accera>/accera/python/llvm/dist
cd ../llvm
python setup.py bdist_wheel

# build the accera-gpu package
# staging folder: <path_to_accera>/build/lib.*-accera_gpu
# package folder: <path_to_accera>/accera/python/gpu/dist
cd ../gpu
python setup.py bdist_wheel
```

### Installing the packages
By default, `pip` searches PyPI for package dependencies. To override this
behavior when you are installing local packages, use the `--find-links` flag
so that `pip` will search your local `dist` folders first:

For example, to install a locally-built `accera` package and its dependencies:

```shell
cd <path_to_accera>/dist
pip install accera-<version>-<arch>.whl \
 --find-links=../accera/python/compilers/dist \
 --find-links=../accera/python/llvm/dist
```

On Windows the `pip` command can be:

```shell
pip install accera-<version>-<arch>.whl --find-links=..\accera\python\compilers\dist --find-links=..\accera\python\llvm\dist
```

## Bindings

The bindings are mostly complete. The initial goal was to be able to implement
the modified MLAS Matrix Multiplication algorithm and produce compiled
binaries, all through python.

## Versioning

The `__version__` dunder variable follows a git-based versioning scheme, which changes
based on the state of the repo. `_version.py` is automatically generated by setuptools_scm,
and should not be checked in.

When a package is built, only the tag portion of the version string will be part of the
wheel filename.

An illustration of how this works (assume the commands are run in order):

```
[Dev version] Clean but not currently at a tag: <tag>.dev<distance_from_last_tag>+g<commit_id>`

/code/accera# python setup.py build bdist_wheel

_version.py:
__version__ = 0.0.1.dev7068+g99ceb5f

[Release tagged version] Clean and tagged (tag format must be n[.n]+): <tag>

/code/accera# git tag 0.0.1
/code/accera# python setup.py build bdist_wheel

_version.py:
__version__ = 0.0.1

[Dev version] Dirty: <tag++>.dev<distance_from_last_tag>+g<commit_id>.d<date>

/code/accera# echo "test" >> README.md
/code/accera# python setup.py build bdist_wheel

_version.py:
__version__ = 0.0.2.dev0+g99ceb5fbb.d20210501

[Dev version] Clean + commits: <tag++>.dev<distance_from_last_tag>+g<commit_id>

/code/accera# git add README.md
/code/accera# git commit -m"dummy change" README.md
[dev/onglisa/3255_setup_cfg_versioning 67ed68cb8] dummy change
 1 file changed, 1 insertion(+)
/code/accera# python setup.py build bdist_wheel

_version.py:
__version__ = 0.0.2.dev1+g67ed68cb8

/code/accera# git revert 67ed68cb8
[dev/onglisa/3255_setup_cfg_versioning e9b358477] Revert "dummy change"
 1 file changed, 1 deletion(-)
/code/accera# python setup.py build bdist_wheel

_version.py:
__version__ = 0.0.2.dev2+ge9b358477
```

## What's left
* Filling in the various package details, such as License, docs, etc.
* Acknowledging that we're distributing LLVM binaries
* Making the Python API prettier
